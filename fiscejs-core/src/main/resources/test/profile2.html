<html>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>

<script type="text/javascript" src="../fisce/aot.js"></script>

<script type="text/javascript" src="../fisce/portable.js"></script>
<script type="text/javascript" src="../fisce/long.asm.js"></script>
<script type="text/javascript" src="../fisce/hashmapio.js"></script>
<script type="text/javascript" src="../fisce/hashmapi.js"></script>
<script type="text/javascript" src="../fisce/gunzip.minjs"></script>
<script type="text/javascript" src="../fisce/vfs.js"></script>
<script type="text/javascript" src="../fisce/structs.js"></script>
<script type="text/javascript" src="../fisce/method.js"></script>
<script type="text/javascript" src="../fisce/field.js"></script>
<script type="text/javascript" src="../fisce/class.js"></script>
<script type="text/javascript" src="../fisce/context.js"></script>
<script type="text/javascript" src="../fisce/heap.js"></script>
<script type="text/javascript" src="../fisce/classloader.js"></script>
<script type="text/javascript" src="../fisce/thread.js"></script>
<script type="text/javascript" src="../fisce/threadmanager.js"></script>
<script type="text/javascript" src="../fisce/aot.native.js"></script>

<script type="text/javascript" src="../aot.data.js"></script>

<script type="text/javascript" src="../fisce/nh.core.js"></script>
<script type="text/javascript" src="../fisce/nh.reflect.js"></script>
<script type="text/javascript" src="../fisce/nh.math.js"></script>
<script type="text/javascript">
	var clazz = "com/cirnoworks/fisce/privat/Profile";
	var context = new FyContext();
</script>

</head>
<body onload="startup();">
	<pre id="console">Loading...</pre>
	<script type="text/javascript" src="../fisce/rt.js.gz"></script>
	<script type="text/javascript" src="../fisce/rt-vfs.js.gz"></script>
	<script type="text/javascript">
		function startup() {
			if (window.console) {
				window.oldConsole = window.console;
			} else {
				window = oldConsole = {
					log : function() {
					}
				}
			}
			window.console = {
				log : function(param) {
					document.getElementById("console").appendChild(
							document.createTextNode(param + "\n"));
					window.oldConsole.log.apply(window.oldConsole, arguments);
				}
			}
			context
					.registerNativeHandler(
							"EXCLUDE/fisce/test/TestService.fail0.(Ljava/lang/String;)V",
							function(context, thread, ops) {
								throw new FyException(
										"java/lang/Error",
										"Test failed: "
												+ context.heap
														.getString(thread.stack[thread.sp]));
								return 0;
							});
			context.bootup(clazz);
			function Exec(context) {
				this.context = context;
				this.message = new FyMessage();
				this.fun = function() {
					try {
						context.threadManager.run(this.message);
					} catch (e) {
						console.log("##HL " + clazz + " end with exception");
						throw e;
					}
					switch (this.message.type) {
					case FyMessage.message_vm_dead:
						console.log("##HL " + clazz + " end");
						return;
					case FyMessage.message_sleep:
						var target = performance.now()
								+ Number(this.message.sleepTime);
						if (target !== target) {
							// Nan
							throw new FyException(undefined,
									"Illegal sleep time: " + sleepTime);
						}
						var delay = target - performance.now();
						if (delay < 0) {
							delay = 0;
						}
						if (delay > 0) {
							console.log("sleep " + delay + "ms");
							setTimeout(this.f2, delay);
						} else {
							this.fun();
						}
						break;
					default:
						console.log("##HL " + clazz + " end with exception");
						throw new FyException(undefined,
								"Unknown message type: " + message.type);
					}
				};
				this.f2 = this.fun.bind(this);
			}
			var exec = new Exec(context);
			setTimeout(exec.f2, 1);
		}
	</script>
</body>
</html>
